<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è²å­¸èˆ‡éŸ³éŸ¿ç§‘å­¸æ¨¡æ“¬å·¥ä½œç«™ (SPA v2.0)</title>
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KD1MQ90SZJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-KD1MQ90SZJ', {
          'send_page_view': true 
      });
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- è¨­å®š Tailwind ä¸»é¡Œèˆ‡å­—é«” -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2c3e50',
                        accent: '#3498db',
                        warm: '#fdfbf7', // æš–è‰²èª¿èƒŒæ™¯
                    },
                    fontFamily: {
                        sans: ['"Microsoft JhengHei"', '"Heiti TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- åµŒå…¥å¼æ¨£å¼ï¼šè™•ç†åœ–è¡¨å®¹å™¨ -->
    <style>
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px; /* é è¨­é«˜åº¦ */
            max-height: 500px;
        }
        canvas {
            touch-action: none; /* é˜²æ­¢æ‰‹æ©Ÿæ»‘å‹•é é¢å¹²æ“¾ç•«å¸ƒæ“ä½œ */
        }
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒåŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-warm text-slate-800 font-sans min-h-screen flex flex-col">

    <!-- é é¦– -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="cursor-pointer" onclick="app.showView('dashboard')">
                <h1 class="text-xl md:text-2xl font-bold text-primary flex items-center gap-2">
                    <img src="favicon.png" alt="Logo" class="w-8 h-8 object-contain"> è²å­¸æ¨¡æ“¬å·¥ä½œç«™
                </h1>
                <p class="text-xs text-slate-500 hidden md:block">Acoustic & Audio Science Simulation Workstation</p>
            </div>
            <button id="back-btn" onclick="app.showView('dashboard')" class="hidden px-4 py-2 text-sm font-medium text-slate-600 hover:text-accent transition-colors flex items-center gap-1">
                <span>â†</span> è¿”å›ä¸»é¸å–®
            </button>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="flex-grow container max-w-6xl mx-auto px-4 py-6">
        
        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="animate-fade-in">
            <div class="text-center mb-10 space-y-2">
                <h2 class="text-3xl font-bold text-slate-800">æ¢ç´¢è²éŸ³çš„ç‰©ç†ç‰¹æ€§</h2>
                <p class="text-slate-600 max-w-2xl mx-auto">
                    é¸æ“‡ä¸‹æ–¹æ¨¡çµ„ï¼Œé€éäº’å‹•æ¨¡æ“¬æ·±å…¥äº†è§£éŸ³éŸ¿å·¥ç¨‹ã€è½åŠ›å­¸èˆ‡å»ºç¯‰è²å­¸çš„æ ¸å¿ƒåŸç†ã€‚
                </p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6">
                <!-- Card A: Delay -->
                <div class="bg-white p-6 rounded-2xl shadow-md hover:shadow-xl transition-all cursor-pointer border border-slate-100 group" onclick="app.showView('delay')">
                    <div class="flex items-start justify-between mb-4">
                        <span class="text-4xl bg-blue-50 p-3 rounded-xl group-hover:scale-110 transition-transform">ğŸ™ï¸</span>
                        <span class="px-3 py-1 bg-slate-100 text-slate-500 text-xs rounded-full">Live Sound</span>
                    </div>
                    <h3 class="text-xl font-bold text-primary mb-2 group-hover:text-accent transition-colors">å»¶é²è£œå„Ÿæ¨¡æ“¬</h3>
                    <p class="text-slate-500 text-sm leading-relaxed mb-4">
                        æ¨¡æ“¬å¤§å‹æ¼”å”±æœƒä¸­ä¸»å–‡å­èˆ‡å»¶é²å¡”çš„æ™‚é–“å·®ï¼Œè¦–è¦ºåŒ–è·é›¢èˆ‡æŒ‡å‘æ€§é€ æˆçš„è²å£“è¡°æ¸›èˆ‡æ¢³ç‹€æ¿¾æ³¢æ•ˆæ‡‰ã€‚
                    </p>
                    <div class="text-accent font-semibold text-sm flex items-center gap-1">
                        é€²å…¥æ¨¡æ“¬ <span class="group-hover:translate-x-1 transition-transform">â†’</span>
                    </div>
                </div>

                <!-- Card B: Mic -->
                <div class="bg-white p-6 rounded-2xl shadow-md hover:shadow-xl transition-all cursor-pointer border border-slate-100 group" onclick="app.showView('mic')">
                    <div class="flex items-start justify-between mb-4">
                        <span class="text-4xl bg-purple-50 p-3 rounded-xl group-hover:scale-110 transition-transform">ğŸ¤</span>
                        <span class="px-3 py-1 bg-slate-100 text-slate-500 text-xs rounded-full">Recording</span>
                    </div>
                    <h3 class="text-xl font-bold text-primary mb-2 group-hover:text-accent transition-colors">éº¥å…‹é¢¨æŒ‡å‘æ€§</h3>
                    <p class="text-slate-500 text-sm leading-relaxed mb-4">
                        äº’å‹•å¼æ¥µåº§æ¨™åœ–ã€‚æ¢ç´¢å¿ƒå‹ã€è¶…å¿ƒå‹èˆ‡æ§å‹éº¥å…‹é¢¨çš„æ”¶éŸ³ç¯„åœï¼Œä»¥åŠé«˜é »éŠ³åŒ– (Sharpening) ç¾è±¡ã€‚
                    </p>
                    <div class="text-accent font-semibold text-sm flex items-center gap-1">
                        é€²å…¥æ¨¡æ“¬ <span class="group-hover:translate-x-1 transition-transform">â†’</span>
                    </div>
                </div>

                <!-- Card C: Loudness -->
                <div class="bg-white p-6 rounded-2xl shadow-md hover:shadow-xl transition-all cursor-pointer border border-slate-100 group" onclick="app.showView('loudness')">
                    <div class="flex items-start justify-between mb-4">
                        <span class="text-4xl bg-green-50 p-3 rounded-xl group-hover:scale-110 transition-transform">ğŸ‘‚</span>
                        <span class="px-3 py-1 bg-slate-100 text-slate-500 text-xs rounded-full">Psychoacoustics</span>
                    </div>
                    <h3 class="text-xl font-bold text-primary mb-2 group-hover:text-accent transition-colors">è½åŠ›å­¸èˆ‡ç­‰éŸ¿åº¦</h3>
                    <p class="text-slate-500 text-sm leading-relaxed mb-4">
                        Fletcher-Munson æ›²ç·šäº’å‹•åœ–è¡¨ã€‚æ¨¡æ“¬æ­£å¸¸è½åŠ›èˆ‡è½åŠ›å—æï¼ˆè€å¹´æ€§/å™ªéŸ³å‹ï¼‰çš„é–¾å€¼å·®ç•°åŠåŠ©è½å™¨è£œå„Ÿã€‚
                    </p>
                    <div class="text-accent font-semibold text-sm flex items-center gap-1">
                        é€²å…¥æ¨¡æ“¬ <span class="group-hover:translate-x-1 transition-transform">â†’</span>
                    </div>
                </div>

                <!-- Card D: Reverb -->
                <div class="bg-slate-900 p-6 rounded-2xl shadow-md hover:shadow-xl hover:shadow-slate-800/50 transition-all cursor-pointer border border-slate-800 group" onclick="app.showView('reverb')">
                    <div class="flex items-start justify-between mb-4">
                        <span class="text-4xl bg-slate-800 p-3 rounded-xl group-hover:scale-110 transition-transform">ğŸ </span>
                        <span class="px-3 py-1 bg-slate-800 text-slate-300 text-xs rounded-full">Acoustics</span>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2 group-hover:text-yellow-400 transition-colors">å®¤å…§æ®˜éŸ¿ RT60</h3>
                    <p class="text-slate-400 text-sm leading-relaxed mb-4">
                        ä½¿ç”¨å‹•æ…‹ç²’å­ç³»çµ±é€²è¡Œå…‰ç·šè¿½è¹¤ (Ray Tracing)ï¼Œè¦–è¦ºåŒ–è²æ³¢åœ¨ä¸åŒæè³ªæˆ¿é–“ä¸­çš„åå°„ã€æ“´æ•£èˆ‡èƒ½é‡è¡°æ¸›ã€‚
                    </p>
                    <div class="text-yellow-400 font-semibold text-sm flex items-center gap-1">
                        é€²å…¥æš—æˆ¿æ¨¡æ“¬ <span class="group-hover:translate-x-1 transition-transform">â†’</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: DELAY SIMULATION -->
        <div id="view-delay" class="hidden animate-fade-in space-y-6">
            <!-- å°è®€ -->
            <details class="bg-amber-50 border border-amber-200 rounded-xl p-4 cursor-pointer">
                <summary class="font-bold text-amber-800 flex items-center gap-2">
                    <span>ğŸ’¡</span> 1åˆ†é˜åŸç†ï¼šç‚ºä»€éº¼æ¼”å”±æœƒéœ€è¦ã€Œå»¶é²å¡”ã€ï¼Ÿ
                </summary>
                <div class="mt-3 text-sm text-amber-900 leading-relaxed border-t border-amber-200 pt-3">
                    <p class="mb-2"><strong>è²éŸ³é€Ÿåº¦å¾ˆæ…¢ (343 m/s)</strong>ã€‚åœ¨å¤§å‹å ´åœ°ï¼Œè²éŸ³å‚³åˆ°å¾Œæ’å¯èƒ½å»¶é² 0.5 ç§’ä»¥ä¸Šã€‚</p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>ç„¡è£œå„Ÿ</strong>ï¼šå¾Œæ’è§€çœ¾æœƒå…ˆè½åˆ°è¼ƒè¿‘çš„å»¶é²å¡” (S2)ï¼Œå†è½åˆ°ä¸»èˆå° (S1)ï¼Œé€ æˆ<strong>å›éŸ³èˆ‡æ¨¡ç³Š</strong>ã€‚</li>
                        <li><strong>è‡ªå‹•è£œå„Ÿ</strong>ï¼šè®“ S2 <strong>ã€Œæ™šä¸€é»ç™¼è²ã€</strong> (é›»å­å»¶é²)ï¼Œç­‰å¾… S1 è²æ³¢åˆ°é”ã€‚ç•¶å…©è€…<strong>åŒæ™‚</strong>æŠµé”è§€çœ¾è€³æœµï¼Œè²éŸ³æ‰æœƒæ¸…æ™°æœ‰åŠ›ã€‚</li>
                    </ul>
                </div>
            </details>

            <div class="grid lg:grid-cols-3 gap-6">
                <!-- Canvas Area -->
                <div class="lg:col-span-2 bg-slate-900 rounded-2xl p-1 overflow-hidden shadow-lg relative h-[400px] lg:h-[500px]">
                    <canvas id="delayCanvas" class="w-full h-full block cursor-crosshair"></canvas>
                    <div class="absolute bottom-4 left-4 text-xs text-slate-400 bg-black/50 px-2 py-1 rounded pointer-events-none">
                        é»æ“Šæˆ–æ‹–æ›³é»‘è‰²å€åŸŸç§»å‹•è§€çœ¾ (L)
                    </div>
                </div>

                <!-- Controls & Stats -->
                <div class="space-y-4">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100">
                        <label class="block text-sm font-bold text-slate-700 mb-3">æ¨¡å¼é¸æ“‡</label>
                        <div class="flex gap-2">
                            <button id="btn-delay-raw" onclick="DelaySim.setMode(false)" class="flex-1 py-2 px-3 rounded-lg text-sm font-semibold transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200">
                                ç„¡è£œå„Ÿ (Raw)
                            </button>
                            <button id="btn-delay-auto" onclick="DelaySim.setMode(true)" class="flex-1 py-2 px-3 rounded-lg text-sm font-semibold transition-colors bg-accent text-white shadow-lg shadow-blue-500/30">
                                è‡ªå‹•è£œå„Ÿ (Aligned)
                            </button>
                        </div>
                        <button id="btn-delay-anim" onclick="DelaySim.startAnimation()" class="w-full mt-3 py-2 px-3 rounded-lg text-sm font-bold transition-colors bg-green-500 text-white shadow-md hover:bg-green-600 flex items-center justify-center gap-2">
                            <span>â–¶</span> æ’­æ”¾è²æ³¢å‚³éæ¼”ç¤º (æ…¢å‹•ä½œ)
                        </button>
                    </div>

                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 space-y-3 text-sm">
                        <h3 class="font-bold text-slate-700 border-b pb-2">â±ï¸ æ™‚é–“èˆ‡ç›¸ä½</h3>
                        <div class="flex justify-between"><span class="text-slate-500">S1 åˆ°é”æ™‚é–“</span><span id="d-t1" class="font-mono">-- ms</span></div>
                        <div class="flex justify-between"><span class="text-slate-500">S2 åˆ°é”æ™‚é–“</span><span id="d-t2" class="font-mono">-- ms</span></div>
                        <div class="flex justify-between font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded">
                            <span>æ™‚é–“å·® (Î”t)</span><span id="d-delta">-- ms</span>
                        </div>
                        <div class="flex justify-between text-accent"><span class="text-slate-500">ç³»çµ±è£œå„Ÿ</span><span id="d-comp">0.0 ms</span></div>
                        <div id="d-warn" class="hidden text-xs text-red-500 font-bold bg-red-50 p-2 rounded mt-2">
                            âš ï¸ è­¦å‘Šï¼šæ™‚é–“å·® < 15msï¼Œæ˜“ç”¢ç”Ÿæ¢³ç‹€æ¿¾æ³¢ï¼
                        </div>
                    </div>

                    <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-100 space-y-3 text-sm">
                        <h3 class="font-bold text-slate-700 border-b pb-2">ğŸ”Š éŸ³é‡åˆ†æ (SPL)</h3>
                        <div class="flex justify-between"><span class="text-slate-500">S1 éŸ³é‡</span><span id="d-spl1" class="font-mono">-- dB</span></div>
                        <div class="flex justify-between"><span class="text-slate-500">S2 éŸ³é‡</span><span id="d-spl2" class="font-mono">-- dB</span></div>
                        <div class="flex justify-between font-bold"><span class="text-slate-500">éŸ³é‡å·®</span><span id="d-diff">-- dB</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VIEW: MIC SIMULATION -->
        <div id="view-mic" class="hidden animate-fade-in space-y-6">
            <details class="bg-blue-50 border border-blue-200 rounded-xl p-4 cursor-pointer">
                <summary class="font-bold text-blue-800 flex items-center gap-2">
                    <span>ğŸ’¡</span> 1åˆ†é˜åŸç†ï¼šé€™å¼µåœ–ä»£è¡¨ä»€éº¼ï¼Ÿ
                </summary>
                <div class="mt-3 text-sm text-blue-900 leading-relaxed border-t border-blue-200 pt-3">
                    <p class="mb-2">é€™å¼µæ¥µåº§æ¨™åœ–é¡¯ç¤ºäº†éº¥å…‹é¢¨çš„ã€Œè€³æœµå½¢ç‹€ã€ï¼š</p>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>ä¸­å¿ƒåœ–ç¤º</strong>ï¼šä»£è¡¨éº¥å…‹é¢¨æœ¬é«”ï¼Œæœå‘ä¸Šæ–¹ï¼ˆ0åº¦ï¼‰ã€‚</li>
                        <li><strong>ç¶ è‰²é»</strong>ï¼šä¸»å”±æˆ–ç›®æ¨™éŸ³æºï¼ˆæ°¸é åœ¨æ­£å‰æ–¹ï¼‰ã€‚</li>
                        <li><strong>ç´…è‰²é»</strong>ï¼šå¯ç§»å‹•çš„å™ªéŸ³æºã€‚</li>
                        <li><strong>ç´…ç·šç²—ç´°</strong>ï¼šä»£è¡¨å™ªéŸ³è¢«éº¥å…‹é¢¨æ”¶éŒ„çš„éŸ³é‡ã€‚<strong>ç·šè¶Šç´°ï¼Œä»£è¡¨é™å™ªæ•ˆæœè¶Šå¥½</strong>ã€‚</li>
                    </ul>
                </div>
            </details>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Wrapper (Controls + Stats) -->
                <div class="contents lg:block lg:space-y-4">
                    
                    <!-- Controls (Order 1) -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 space-y-5 order-1">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">éº¥å…‹é¢¨é¡å‹</label>
                            <select id="m-type" onchange="MicSim.update(); gtag('event', 'mic_type_change', {'type': this.value})" class="w-full p-2 border border-slate-300 rounded-lg bg-slate-50 focus:ring-2 focus:ring-accent outline-none">
                                <option value="cardioid">å¿ƒå‹ (Cardioid)</option>
                                <option value="supercardioid">è¶…å¿ƒå‹ (Supercardioid)</option>
                                <option value="shotgun">æ§å‹ (Shotgun)</option>
                                <option value="omni">å…¨æŒ‡å‘ (Omni)</option>
                            </select>
                        </div>

                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-sm font-bold text-slate-700">é »ç‡ (Hz)</label>
                                <span id="m-freq-val" class="text-sm font-mono text-accent">1000 Hz</span>
                            </div>
                            <!-- onchange ç”¨æ–¼ GA è¿½è¹¤ï¼Œé¿å…æ»‘å‹•æ™‚é »ç¹ç™¼é€ -->
                            <input type="range" id="m-freq" min="100" max="10000" step="100" value="1000" oninput="MicSim.update()" onchange="gtag('event', 'mic_freq_change', {'value': this.value})" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-accent">
                            <p class="text-xs text-slate-500 mt-1">é«˜é »æœƒå°è‡´æŒ‡å‘æ€§è®Šçª„ (Sharpening)</p>
                        </div>

                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-sm font-bold text-slate-700">å™ªéŸ³æºè§’åº¦ (Â°)</label>
                                <span id="m-angle-val" class="text-sm font-mono text-red-500">180Â°</span>
                            </div>
                            <input type="range" id="m-angle" min="0" max="359" value="180" oninput="MicSim.update()" onchange="gtag('event', 'mic_noise_angle_change', {'value': this.value})" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-500">
                        </div>
                    </div>

                    <!-- Stats (Order 3) -->
                    <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 order-3">
                        <h3 class="text-sm font-bold text-blue-800 mb-3 border-b border-blue-200 pb-2">æ•¸æ“šåˆ†æ</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-blue-700">èªéŸ³ Gain (0Â°)</span><span id="m-gain-voice" class="font-mono font-bold">0.0 dB</span></div>
                            <div class="flex justify-between"><span class="text-blue-700">å™ªéŸ³ Gain</span><span id="m-gain-noise" class="font-mono font-bold text-red-600">-20.0 dB</span></div>
                            <div class="mt-2 pt-2 border-t border-blue-200 flex justify-between items-center">
                                <span class="text-blue-900 font-bold">è¨Šå™ªæ¯” (SNR) æ”¹å–„</span>
                                <span id="m-snr" class="text-xl font-bold text-accent">20.0 dB</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Canvas (Order 2) -->
                <div class="flex justify-center items-center bg-white rounded-2xl shadow-sm border border-slate-100 p-4 order-2 lg:order-none lg:h-auto">
                    <canvas id="polarCanvas" width="400" height="400" class="max-w-full h-auto"></canvas>
                </div>
            </div>
        </div>

        <!-- VIEW: LOUDNESS SIMULATION -->
        <div id="view-loudness" class="hidden animate-fade-in space-y-6">
            <details class="bg-green-50 border border-green-200 rounded-xl p-4 cursor-pointer">
                <summary class="font-bold text-green-800 flex items-center gap-2">
                    <span>ğŸ’¡</span> 1åˆ†é˜åŸç†ï¼šäººè€³ä¸æ˜¯å®Œç¾çš„éº¥å…‹é¢¨
                </summary>
                <div class="mt-3 text-sm text-green-900 leading-relaxed border-t border-green-200 pt-3">
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>ä¸­é »æ•æ„Ÿ</strong>ï¼šäººèªªè©±çš„é »ç‡ (1k-4k Hz) æˆ‘å€‘è½å¾—æœ€æ¸…æ¥šã€‚</li>
                        <li><strong>ä½é »é²éˆ</strong>ï¼šè«‹çœ‹åœ–è¡¨å·¦å´ï¼Œ20Hz çš„è²éŸ³è¦é–‹åˆ° <strong>70dB</strong> æˆ‘å€‘æ‰å‹‰å¼·è½è¦‹ã€‚</li>
                        <li><strong>è½åŠ›å—æ</strong>ï¼šé€šå¸¸å¾<strong>é«˜é »</strong>é–‹å§‹æµå¤±ã€‚è©¦è‘—é–‹å•Ÿã€Œè€å¹´æ€§è½æã€æ¨¡å¼ï¼Œè§€å¯Ÿå³å´æ›²ç·šå¦‚ä½•é£†é«˜ï¼ˆä»£è¡¨éœ€è¦æ›´å¤§è²æ‰è½å¾—è¦‹ï¼‰ã€‚</li>
                    </ul>
                </div>
            </details>

            <!-- Controls -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-wrap gap-4 items-center">
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-xs font-bold text-slate-500 mb-1">ğŸ¦» è½åŠ›ç‹€æ³</label>
                    <select id="l-condition" onchange="LoudnessSim.update()" class="w-full p-2 border border-slate-300 rounded-lg text-sm outline-none focus:border-accent">
                        <option value="normal">æ­£å¸¸è½åŠ› (Normal)</option>
                        <option value="presbycusis">è€å¹´æ€§è½æ (é«˜é »æµå¤±)</option>
                        <option value="noise">å™ªéŸ³å‹è½æ (4kHz å‡¹é™·)</option>
                    </select>
                </div>
                <div class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200">
                    <input type="checkbox" id="l-aid" onchange="LoudnessSim.update()" disabled class="w-4 h-4 accent-green-500">
                    <label for="l-aid" class="text-sm font-medium text-slate-700 cursor-pointer select-none">å•Ÿç”¨åŠ©è½å™¨è£œå„Ÿ</label>
                </div>
            </div>

            <!-- Chart -->
            <div class="chart-container bg-white p-2 rounded-2xl shadow-sm border border-slate-100">
                <canvas id="loudnessChart"></canvas>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-slate-50 p-3 rounded-lg text-center">
                    <div class="text-xs text-slate-500">é »ç‡ (Hz)</div>
                    <div id="l-val-freq" class="text-lg font-bold text-slate-700">--</div>
                </div>
                <div class="bg-slate-50 p-3 rounded-lg text-center">
                    <div class="text-xs text-slate-500">è²å£“ç´š (dB)</div>
                    <div id="l-val-spl" class="text-lg font-bold text-slate-700">--</div>
                </div>
                <div class="bg-slate-50 p-3 rounded-lg text-center border-b-2 border-accent">
                    <div class="text-xs text-slate-500">æ„ŸçŸ¥éŸ¿åº¦</div>
                    <div id="l-val-phon" class="text-lg font-bold text-accent">-- Phon</div>
                </div>
            </div>
        </div>

        <!-- VIEW: REVERB SIMULATION -->
        <div id="view-reverb" class="hidden animate-fade-in space-y-6">
            <!-- ç‰¹æ®Šæš—è‰²ä¸»é¡Œå®¹å™¨ -->
            <div class="bg-slate-900 rounded-3xl p-6 shadow-2xl border border-slate-700">
                <div class="flex flex-col lg:flex-row gap-6">
                    
                    <!-- Controls (Dark Mode) -->
                    <div class="lg:w-1/3 space-y-6">
                        <div class="space-y-4">
                            <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                                ğŸ  æ®˜éŸ¿å¯¦é©—å®¤
                            </h2>
                            <details class="bg-slate-800 rounded-lg p-3 text-sm text-slate-300">
                                <summary class="cursor-pointer font-bold text-yellow-400">ä»€éº¼æ˜¯ RT60ï¼Ÿ</summary>
                                <p class="mt-2 text-xs leading-relaxed">
                                    è²éŸ³åœæ­¢å¾Œï¼Œèƒ½é‡è¡°æ¸› 60dB æ‰€éœ€çš„æ™‚é–“ã€‚
                                    <br>â€¢ ç¡¬æè³ª (æ··å‡åœŸ) = åå°„å¤š = RT60 é•·
                                    <br>â€¢ è»Ÿæè³ª (å¸éŸ³æ£‰) = å¸æ”¶å¤š = RT60 çŸ­
                                </p>
                            </details>
                        </div>

                        <div class="space-y-4 bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs text-slate-400">é•·åº¦ (m)</label>
                                    <input type="number" id="r-l" value="20" min="5" max="50" onchange="ReverbSim.updateCalc()" class="w-full bg-slate-700 text-white p-2 rounded border border-slate-600">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-400">å¯¬åº¦ (m)</label>
                                    <input type="number" id="r-w" value="15" min="5" max="50" onchange="ReverbSim.updateCalc()" class="w-full bg-slate-700 text-white p-2 rounded border border-slate-600">
                                </div>
                                <div class="col-span-2">
                                    <label class="text-xs text-slate-400">é«˜åº¦ (m)</label>
                                    <input type="number" id="r-h" value="5" min="2" max="20" onchange="ReverbSim.updateCalc()" class="w-full bg-slate-700 text-white p-2 rounded border border-slate-600">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs text-slate-400">ç‰†é¢æè³ª</label>
                                <select id="r-mat" onchange="ReverbSim.updateCalc(); gtag('event', 'reverb_material_change', {'material': this.options[this.selectedIndex].text})" class="w-full bg-slate-700 text-white p-2 rounded border border-slate-600 mt-1">
                                    <option value="0.03">æ··å‡åœŸ (Î±=0.03) - ç¡¬</option>
                                    <option value="0.15">æœ¨æ¿ç‰† (Î±=0.15) - ä¸­</option>
                                    <option value="0.60">çª—ç°¾/è»Ÿè£ (Î±=0.60) - è»Ÿ</option>
                                    <option value="0.90">éŒ„éŸ³å®¤ (Î±=0.90) - æ­»å¯‚</option>
                                </select>
                            </div>
                        </div>

                        <div class="bg-slate-800 p-4 rounded-xl border-l-4 border-yellow-400">
                            <div class="text-xs text-slate-400">Sabine RT60 ä¼°ç®—</div>
                            <div id="r-val-rt60" class="text-3xl font-mono font-bold text-yellow-400">-- s</div>
                            <div class="flex gap-3 mt-2 text-xs text-slate-500">
                                <span>V: <span id="r-val-v">0</span> mÂ³</span>
                                <span>S: <span id="r-val-s">0</span> mÂ²</span>
                            </div>
                        </div>

                        <button onclick="ReverbSim.fire()" class="w-full py-3 bg-gradient-to-r from-red-500 to-orange-600 text-white font-bold rounded-xl shadow-lg hover:from-red-600 hover:to-orange-700 active:scale-95 transition-all">
                            ğŸ”Š ç™¼å°„è²æ³¢è„ˆè¡
                        </button>
                    </div>

                    <!-- Canvas (Dark Mode) -->
                    <div class="lg:w-2/3 bg-black rounded-xl overflow-hidden relative border border-slate-700 h-[500px]" id="reverb-container">
                        <canvas id="reverbCanvas" class="w-full h-full block"></canvas>
                        <div class="absolute top-4 left-4 text-xs text-slate-400">
                            Visual: Energy Pulse & Ray Tracing
                        </div>
                        <div class="absolute bottom-4 left-4 flex gap-3 text-xs text-slate-300">
                            <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-white"></span>é«˜èƒ½é‡</div>
                            <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span>åå°„</div>
                            <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-500"></span>ä½èƒ½é‡</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer class="bg-white border-t border-slate-100 py-6 mt-8">
        <div class="text-center text-slate-400 text-sm">
            <p>éŸ³éŸ¿å·¥ç¨‹äº’å‹•æ•™å­¸å¹³å° v2.0 (SPA)</p>
            <p class="mt-1 text-xs">Built with Tailwind CSS & Chart.js</p>
        </div>
    </footer>

    <!-- LOGIC -->
    <script>
        // --- SPA NAVIGATION LOGIC ---
        const app = {
            views: ['dashboard', 'delay', 'mic', 'loudness', 'reverb'],
            showView: (viewId) => {
                // Track Screen View
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'screen_view', {
                        'app_name': 'AcousticSim',
                        'screen_name': viewId
                    });
                }

                // Toggle Views
                app.views.forEach(id => {
                    const el = document.getElementById(`view-${id}`);
                    if (id === viewId) {
                        el.classList.remove('hidden');
                    } else {
                        el.classList.add('hidden');
                    }
                });

                // Toggle Header Button
                const btn = document.getElementById('back-btn');
                if (viewId === 'dashboard') {
                    btn.classList.add('hidden');
                    // Stop Reverb Loop to save battery
                    ReverbSim.stopLoop();
                } else {
                    btn.classList.remove('hidden');
                }

                // Initialize specific modules
                if (viewId === 'delay') DelaySim.init();
                if (viewId === 'mic') MicSim.init();
                if (viewId === 'loudness') LoudnessSim.update();
                if (viewId === 'reverb') ReverbSim.startLoop();
            }
        };

        // --- MODULE A: DELAY SIMULATION ---
        const DelaySim = {
            ctx: null, canvas: null, width: 0, height: 0, scale: 1,
            ROOM_W: 150, ROOM_D: 60,
            S1: {x:10, y:30}, S2: {x:100, y:30}, L: {x:120, y:30},
            autoComp: false,
            isVertical: false,
            offsetX: 0, offsetY: 0,
            
            // Animation State
            anim: { active: false, time: 0, reqId: null },

            init: function() {
                this.canvas = document.getElementById('delayCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => { if(!document.getElementById('view-delay').classList.contains('hidden')) this.resize(); });
                
                // Events
                const updatePos = (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    
                    let x, y;
                    
                    if (this.isVertical) {
                        const offX = (this.width - (this.ROOM_D * this.scale)) / 2;
                        const offY = 0;
                        const visualX = clientX - rect.left;
                        const visualY = clientY - rect.top;
                        y = (visualX - offX) / this.scale;
                        x = (visualY - offY) / this.scale;
                    } else {
                        const offX = 0;
                        const offY = (this.height - (this.ROOM_D * this.scale)) / 2;
                        const visualX = clientX - rect.left;
                        const visualY = clientY - rect.top;
                        x = (visualX - offX) / this.scale;
                        y = (visualY - offY) / this.scale;
                    }

                    this.L.x = Math.max(0, Math.min(this.ROOM_W, x));
                    this.L.y = Math.max(0, Math.min(this.ROOM_D, y));
                    this.draw();
                    this.calc();
                };
                this.canvas.onmousedown = (e) => { updatePos(e); this.canvas.onmousemove = updatePos; };
                this.canvas.onmouseup = () => { this.canvas.onmousemove = null; };
                this.canvas.ontouchstart = (e) => { updatePos(e); e.preventDefault(); };
                this.canvas.ontouchmove = (e) => { updatePos(e); e.preventDefault(); };

                this.setMode(false); // Default
            },

            resize: function() {
                const p = this.canvas.parentElement;
                this.canvas.width = p.clientWidth;
                this.canvas.height = p.clientHeight;
                this.width = this.canvas.width;
                this.height = this.canvas.height;
                this.isVertical = (this.width < 600);

                if (this.isVertical) {
                    this.scale = this.height / this.ROOM_W;
                    this.offsetX = (this.width - (this.ROOM_D * this.scale)) / 2;
                    this.offsetY = 0;
                } else {
                    this.scale = this.width / this.ROOM_W;
                    this.offsetX = 0;
                    this.offsetY = (this.height - (this.ROOM_D * this.scale)) / 2;
                }
                this.draw();
            },

            setMode: function(isAuto) {
                this.autoComp = isAuto;
                // Track event
                gtag('event', 'delay_mode_change', {'mode': isAuto ? 'aligned' : 'raw'});

                document.getElementById('btn-delay-raw').className = isAuto ? 'flex-1 py-2 px-3 rounded-lg text-sm font-semibold transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200' : 'flex-1 py-2 px-3 rounded-lg text-sm font-semibold transition-colors bg-accent text-white shadow-lg shadow-blue-500/30';
                document.getElementById('btn-delay-auto').className = !isAuto ? 'flex-1 py-2 px-3 rounded-lg text-sm font-semibold transition-colors bg-slate-100 text-slate-600 hover:bg-slate-200' : 'flex-1 py-2 px-3 rounded-lg text-sm font-semibold transition-colors bg-accent text-white shadow-lg shadow-blue-500/30';
                this.calc();
            },

            calc: function() {
                const dist = (p1, p2) => Math.sqrt((p1.x-p2.x)**2 + (p1.y-p2.y)**2);
                const d1 = dist(this.S1, this.L);
                const d2 = dist(this.S2, this.L);
                
                const t1 = (d1/343)*1000;
                const comp = this.autoComp ? ((this.S2.x - this.S1.x)/343)*1000 : 0;
                const t2 = (d2/343)*1000 + comp;
                
                const delta = Math.abs(t1-t2);
                
                const spl1 = 110 - 20*Math.log10(Math.max(1, d1));
                const spl2 = 110 - 20*Math.log10(Math.max(1, d2));

                document.getElementById('d-t1').innerText = t1.toFixed(1) + ' ms';
                document.getElementById('d-t2').innerText = t2.toFixed(1) + ' ms';
                document.getElementById('d-delta').innerText = delta.toFixed(1) + ' ms';
                document.getElementById('d-comp').innerText = comp.toFixed(1) + ' ms';
                document.getElementById('d-spl1').innerText = spl1.toFixed(1) + ' dB';
                document.getElementById('d-spl2').innerText = spl2.toFixed(1) + ' dB';
                document.getElementById('d-diff').innerText = Math.abs(spl1-spl2).toFixed(1) + ' dB';
                
                const warn = document.getElementById('d-warn');
                if(delta > 0.1 && delta < 15 && Math.abs(spl1-spl2)<6) warn.classList.remove('hidden');
                else warn.classList.add('hidden');
            },
            
            startAnimation: function() {
                if(this.anim.active) {
                    cancelAnimationFrame(this.anim.reqId);
                }
                
                gtag('event', 'delay_animation_play');
                
                this.anim.active = true;
                this.anim.time = 0; 
                this.loop();
            },

            loop: function() {
                if(!this.anim.active) return;
                
                // Slow motion: 0.8 meters per frame (approx 50m/s visual speed)
                this.anim.time += 0.8; 
                
                if(this.anim.time > 200) {
                    this.anim.active = false;
                    this.draw(); 
                    return;
                }

                this.draw();
                this.anim.reqId = requestAnimationFrame(() => this.loop());
            },
            
            getCanvasPos: function(roomX, roomY) {
                 if (this.isVertical) {
                        return { x: this.offsetX + roomY * this.scale, y: this.offsetY + roomX * this.scale };
                    } else {
                        return { x: this.offsetX + roomX * this.scale, y: this.offsetY + roomY * this.scale };
                    }
            },

            draw: function() {
                const c = this.ctx;
                c.fillStyle = '#0f172a'; // Slate 900
                c.fillRect(0,0,this.width, this.height);
                
                const tr = (x, y) => this.getCanvasPos(x, y);

                // Grid
                c.strokeStyle = '#1e293b';
                c.beginPath();
                for(let x=0; x<=this.ROOM_W; x+=10) {
                    const p1 = tr(x, 0);
                    const p2 = tr(x, this.ROOM_D);
                    c.moveTo(p1.x, p1.y);
                    c.lineTo(p2.x, p2.y);
                }
                c.stroke();

                // Draw Speakers
                const drawSpk = (p, color, label) => {
                    const pos = tr(p.x, p.y);
                    c.fillStyle = color;
                    c.beginPath(); 
                    
                    if (this.isVertical) {
                        c.moveTo(pos.x-10, pos.y); c.lineTo(pos.x-5, pos.y+15); c.lineTo(pos.x+5, pos.y+15); c.lineTo(pos.x+10, pos.y);
                        c.fillText(label, pos.x+15, pos.y+10);
                    } else {
                        c.moveTo(pos.x, pos.y-10); c.lineTo(pos.x+15, pos.y-5); c.lineTo(pos.x+15, pos.y+5); c.lineTo(pos.x, pos.y+10);
                        c.fillText(label, pos.x, pos.y-15);
                    }
                    c.fill();
                    c.fillStyle = '#fff'; c.font = '12px sans-serif'; 
                };

                drawSpk(this.S1, '#3498db', 'S1');
                drawSpk(this.S2, '#e67e22', 'S2');

                // Draw Listener
                const lPos = tr(this.L.x, this.L.y);
                c.fillStyle = '#2ecc71'; c.beginPath(); c.arc(lPos.x, lPos.y, 8, 0, Math.PI*2); c.fill();
                c.fillStyle='#fff'; c.fillText('L', lPos.x+12, lPos.y+4);
                
                // Draw Connecting Lines
                c.setLineDash([5,5]); c.strokeStyle='rgba(255,255,255,0.2)';
                const s1Pos = tr(this.S1.x, this.S1.y);
                const s2Pos = tr(this.S2.x, this.S2.y);
                c.beginPath(); c.moveTo(s1Pos.x, s1Pos.y); c.lineTo(lPos.x, lPos.y); c.stroke();
                c.beginPath(); c.moveTo(s2Pos.x, s2Pos.y); c.lineTo(lPos.x, lPos.y); c.stroke();
                c.setLineDash([]);
                
                // Animation: Draw Waves
                if (this.anim.active || this.anim.time > 0) {
                     const t = this.anim.time;
                     
                     let delayDist = 0;
                     if(this.autoComp) {
                         // Delay distance = distance between S1 and S2
                         delayDist = Math.sqrt(Math.pow(this.S1.x - this.S2.x, 2) + Math.pow(this.S1.y - this.S2.y, 2));
                     }

                     const r1 = t;
                     const r2 = t - delayDist; 

                     // Draw Wave 1 (S1)
                     this.drawWave(this.S1, r1, '#3498db');

                     // Draw Wave 2 (S2) - Only if positive radius
                     if (r2 > 0) {
                         this.drawWave(this.S2, r2, '#e67e22');
                     }
                }
            },
            
            drawWave: function(sourcePos, radiusMeters, color) {
                const ctx = this.ctx;
                const center = this.getCanvasPos(sourcePos.x, sourcePos.y);
                const rPix = radiusMeters * this.scale;
                
                // æ±ºå®šä¸»æ–¹å‘ï¼šå‚ç›´æ¨¡å¼æœä¸‹ (90åº¦/PI/2)ï¼Œæ°´å¹³æ¨¡å¼æœå³ (0åº¦)
                const baseAngle = this.isVertical ? Math.PI / 2 : 0;
                // æ“´æ•£è§’åº¦ï¼šå·¦å³å„ 45 åº¦ï¼Œç¸½å…± 90 åº¦æ‰‡å½¢
                const spread = Math.PI / 4; 

                ctx.beginPath();
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                // ç¹ªè£½æ‰‡å½¢å¼§ç·š
                ctx.arc(center.x, center.y, rPix, baseAngle - spread, baseAngle + spread);
                ctx.stroke();
                
                // ç¹ªè£½æ‰‡å½¢å¡«å……
                ctx.fillStyle = color;
                ctx.globalAlpha = 0.1;
                ctx.beginPath();
                ctx.moveTo(center.x, center.y); // å¾åœ“å¿ƒé–‹å§‹
                ctx.arc(center.x, center.y, rPix, baseAngle - spread, baseAngle + spread);
                ctx.closePath(); // é€£å›åœ“å¿ƒ
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        };

        // --- MODULE B: MIC SIMULATION ---
        const MicSim = {
            ctx: null, canvas: null, 
            init: function() {
                this.canvas = document.getElementById('polarCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.update();
            },
            update: function() {
                const type = document.getElementById('m-type').value;
                const freq = parseInt(document.getElementById('m-freq').value);
                const angle = parseInt(document.getElementById('m-angle').value);

                document.getElementById('m-freq-val').innerText = freq + ' Hz';
                document.getElementById('m-angle-val').innerText = angle + 'Â°';

                const ctx = this.ctx;
                const w = this.canvas.width, h = this.canvas.height;
                const cx = w/2, cy = h/2, R = w*0.4;

                ctx.clearRect(0,0,w,h);
                
                // Grid and Background
                ctx.strokeStyle = '#eee'; ctx.lineWidth=1;
                for(let r=0.25; r<=1; r+=0.25) { ctx.beginPath(); ctx.arc(cx, cy, R*r, 0, Math.PI*2); ctx.stroke(); }
                ctx.beginPath(); ctx.moveTo(cx,0); ctx.lineTo(cx,h); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0,cy); ctx.lineTo(w,cy); ctx.stroke();
                
                // Polar Pattern
                ctx.beginPath(); ctx.lineWidth=3; ctx.strokeStyle='#3498db';
                const sharpen = 1.0 + (freq/5000);
                
                const calcGain = (th) => {
                    let v=0, cos = Math.cos(th);
                    if(type=='omni') v=1;
                    else if(type=='cardioid') v=0.5+0.5*cos;
                    else if(type=='supercardioid') v=0.37+0.63*cos;
                    else if(type=='shotgun') v=0.1+0.9*cos;
                    return Math.pow(Math.abs(v), sharpen);
                };

                for(let a=0; a<=360; a++) {
                    const th = a*Math.PI/180;
                    const r = calcGain(th) * R;
                    const x = cx + r*Math.sin(th);
                    const y = cy - r*Math.cos(th);
                    if(a==0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                }
                ctx.closePath(); ctx.stroke();

                // 1. Draw Microphone (Center) - Pointing UP (0 degrees)
                ctx.fillStyle = '#64748b'; // Slate 500
                ctx.fillRect(cx - 6, cy - 10, 12, 20); // Body
                ctx.beginPath(); ctx.arc(cx, cy - 10, 8, Math.PI, 0); ctx.fill(); // Grille (Top)
                ctx.fillStyle = '#cbd5e1'; // Slate 300
                ctx.fillRect(cx - 2, cy + 10, 4, 15); // Stand/Connector

                // 2. Draw Target Source (0 degrees) - Fixed at top
                const ty = cy - (R + 30);
                ctx.fillStyle = '#2ecc71'; // Green
                ctx.beginPath(); ctx.arc(cx, ty, 8, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#166534'; ctx.font = 'bold 12px sans-serif'; ctx.textAlign='center'; ctx.fillText('ä¸»éŸ³æº', cx, ty - 12);

                // Connection Line (Target)
                ctx.beginPath(); ctx.strokeStyle = '#2ecc71'; ctx.lineWidth = 4;
                ctx.moveTo(cx, ty + 10); ctx.lineTo(cx, cy - 25); ctx.stroke();

                // 3. Draw Noise Source (Variable Angle)
                const thN = angle*Math.PI/180;
                const nx = cx + (R+20)*Math.sin(thN);
                const ny = cy - (R+20)*Math.cos(thN);
                
                // Calculate Gain for visual feedback
                const gNoise = calcGain(thN);
                
                // Visual feedback: Line opacity/width based on gain
                ctx.beginPath();
                // Red color, opacity 0.2 min + gain
                ctx.strokeStyle = `rgba(239, 68, 68, ${0.2 + gNoise * 0.8})`; 
                ctx.lineWidth = 1 + gNoise * 5; // Width varies 1px to 6px
                ctx.setLineDash([4, 4]); // Dashed to distinguish from main source
                ctx.moveTo(nx, ny); ctx.lineTo(cx, cy); ctx.stroke();
                ctx.setLineDash([]);

                // Noise Icon
                ctx.fillStyle = '#ef4444'; // Red
                ctx.beginPath(); ctx.arc(nx, ny, 8, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fff'; ctx.font = 'bold 10px sans-serif'; ctx.fillText('N', nx, ny+3); // Label inside

                // Update Stats text
                const dbNoise = 20*Math.log10(Math.max(0.001, gNoise));
                document.getElementById('m-gain-noise').innerText = dbNoise.toFixed(1) + ' dB';
                document.getElementById('m-snr').innerText = (0 - dbNoise).toFixed(1) + ' dB';
            }
        };

        // --- MODULE C: LOUDNESS SIMULATION ---
        const LoudnessSim = {
            chart: null,
            initCalled: false,
            data0: [70, 45, 30, 20, 12, 5, -2, -5, 12, 15], 
            lossPatterns: {
                'normal': [0,0,0,0,0,0,0,0,0,0],
                'presbycusis': [0, 0, 5, 10, 20, 30, 45, 60, 75, 85],
                'noise': [0, 0, 0, 5, 10, 20, 40, 65, 30, 20]
            },

            update: function() {
                if(!this.chart) this.createChart();
                
                const cond = document.getElementById('l-condition').value;
                const aid = document.getElementById('l-aid');
                const useAid = aid.checked;
                
                if(cond === 'normal') { aid.checked=false; aid.disabled=true; } 
                else { aid.disabled=false; }

                // Track Event for condition change
                gtag('event', 'hearing_config_change', {
                    'condition': cond,
                    'aid_enabled': useAid
                });

                const loss = this.lossPatterns[cond];
                const damaged = this.data0.map((v,i) => v + loss[i]);
                const aided = damaged.map((v,i) => Math.max(this.data0[i], v - loss[i]*0.7));

                this.chart.data.datasets[4].data = damaged;
                this.chart.data.datasets[4].hidden = (cond === 'normal');
                this.chart.data.datasets[5].data = aided;
                this.chart.data.datasets[5].hidden = (!useAid || cond === 'normal');
                this.chart.update();
            },

            createChart: function() {
                const ctx = document.getElementById('loudnessChart').getContext('2d');
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [20, 63, 125, 250, 500, 1000, 2000, 4000, 8000, 12500],
                        datasets: [
                            { label: '80 Phon', data: [118, 102, 92, 88, 83, 80, 77, 75, 90, 95], borderColor: '#e5e7eb', borderDash:[5,5], pointRadius:0 },
                            { label: '60 Phon', data: [105, 85, 76, 70, 64, 60, 57, 55, 70, 75], borderColor: '#e5e7eb', borderDash:[5,5], pointRadius:0 },
                            { label: '40 Phon', data: [92, 70, 60, 52, 45, 40, 37, 35, 48, 50], borderColor: '#3498db', tension:0.4 },
                            { label: '0 Phon (Normal)', data: this.data0, borderColor: '#2ecc71', backgroundColor: 'rgba(46,204,113,0.1)', fill:true, tension:0.4 },
                            { label: 'Loss Threshold', data: [], borderColor: '#ef4444', borderDash:[5,5], borderWidth:3, hidden:true, tension:0.4 },
                            { label: 'Aided', data: [], borderColor: '#10b981', borderWidth:3, hidden:true, tension:0.4 },
                            { label: 'Point', data: [], pointBackgroundColor: 'black', type:'scatter', pointRadius:6 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        interaction: { mode: 'nearest', intersect: false },
                        scales: {
                            x: { type: 'logarithmic', min: 20, max: 16000, title:{display:true, text:'Frequency (Hz)'} },
                            y: { min: -10, max: 130, title:{display:true, text:'SPL (dB)'} }
                        },
                        plugins: { legend: { labels: { filter: i => !i.text.includes('Phon') || i.text.includes('0') } } },
                        onClick: (e, els, chart) => {
                            const pts = Chart.helpers.getRelativePosition(e, chart);
                            const freq = chart.scales.x.getValueForPixel(pts.x);
                            const spl = chart.scales.y.getValueForPixel(pts.y);
                            if(freq && spl) {
                                chart.data.datasets[6].data = [{x:freq, y:spl}];
                                chart.update();
                                document.getElementById('l-val-freq').innerText = Math.round(freq);
                                document.getElementById('l-val-spl').innerText = spl.toFixed(1);
                                
                                let phon = spl;
                                if(freq<1000) phon = spl - (30*(1-Math.log10(freq)/3));
                                if(freq>2000 && freq<6000) phon = spl + 5;
                                document.getElementById('l-val-phon').innerText = '~' + phon.toFixed(0) + ' Phon';

                                // Track Chart Click
                                gtag('event', 'chart_test_point', {
                                    'frequency': Math.round(freq),
                                    'spl': Math.round(spl)
                                });
                            }
                        }
                    }
                });
                // Initial update without tracking (to render default)
                // We call update() in app.showView which triggers tracking, acceptable for first view
            }
        };

        // --- MODULE D: REVERB SIMULATION ---
        const ReverbSim = {
            ctx: null, canvas: null, w:0, h:0, animId: null,
            particles: [],
            
            startLoop: function() {
                if(this.animId) return;
                const container = document.getElementById('reverb-container');
                this.canvas = document.getElementById('reverbCanvas');
                this.ctx = this.canvas.getContext('2d');
                
                const resize = () => {
                    this.canvas.width = container.clientWidth;
                    this.canvas.height = container.clientHeight;
                    this.w = this.canvas.width;
                    this.h = this.canvas.height;
                    this.updateCalc();
                };
                window.addEventListener('resize', () => { 
                    if(!document.getElementById('view-reverb').classList.contains('hidden')) resize(); 
                });
                resize();

                const loop = () => {
                    this.ctx.fillStyle = 'rgba(0,0,0,0.25)';
                    this.ctx.fillRect(0,0,this.w,this.h);

                    const L = parseFloat(document.getElementById('r-l').value) * 10; 
                    const W = parseFloat(document.getElementById('r-w').value) * 10;
                    const cx = this.w/2, cy = this.h/2;
                    const rl = cx-W/2, rt = cy-L/2, rr = cx+W/2, rb = cy+L/2;

                    this.ctx.strokeStyle = '#475569'; this.ctx.lineWidth=4;
                    this.ctx.strokeRect(rl, rt, W, L);
                    this.ctx.fillStyle = '#fff'; this.ctx.beginPath(); this.ctx.arc(cx,cy,4,0,Math.PI*2); this.ctx.fill();

                    const alpha = parseFloat(document.getElementById('r-mat').value);
                    this.particles.forEach(p => {
                        p.x += p.vx; p.y += p.vy;
                        let hit = false;
                        if(p.x <= rl) { p.x=rl; p.vx*=-1; hit=true; }
                        else if(p.x >= rr) { p.x=rr; p.vx*=-1; hit=true; }
                        if(p.y <= rt) { p.y=rt; p.vy*=-1; hit=true; }
                        else if(p.y >= rb) { p.y=rb; p.vy*=-1; hit=true; }
                        
                        if(hit) { p.e *= (1-alpha); if(p.e<0.05) p.dead=true; }
                        
                        if(!p.dead) {
                            const c = p.e>0.8?'#fff':(p.e>0.5?'#facc15':'#ef4444');
                            this.ctx.fillStyle = c;
                            this.ctx.fillRect(p.x,p.y,3,3); 
                        }
                    });
                    this.particles = this.particles.filter(p => !p.dead);
                    
                    this.animId = requestAnimationFrame(loop);
                };
                loop();
            },

            stopLoop: function() {
                if(this.animId) cancelAnimationFrame(this.animId);
                this.animId = null;
            },

            fire: function() {
                // Track fire event
                gtag('event', 'reverb_fire', {'particle_count': 100});

                this.particles = [];
                const cx = this.w/2, cy = this.h/2;
                const count = 100; 
                const speed = 5 / 8;

                for(let i=0; i<count; i++) {
                    const a = (Math.PI*2*i)/count;
                    this.particles.push({
                        x:cx, y:cy, 
                        vx:Math.cos(a)*speed, 
                        vy:Math.sin(a)*speed, 
                        e:1, dead:false
                    });
                }
            },

            updateCalc: function() {
                const l = parseFloat(document.getElementById('r-l').value);
                const w = parseFloat(document.getElementById('r-w').value);
                const h = parseFloat(document.getElementById('r-h').value);
                const mat = parseFloat(document.getElementById('r-mat').value);
                const V = l*w*h;
                const S = 2*(l*w + l*h + w*h);
                const rt60 = (0.161*V)/(S*mat);
                document.getElementById('r-val-rt60').innerText = rt60.toFixed(2) + ' s';
                document.getElementById('r-val-v').innerText = V;
                document.getElementById('r-val-s').innerText = S;
            }
        };

        // Init App
        document.addEventListener('DOMContentLoaded', () => {
             // Default view
        });

    </script>
</body>
</html>
